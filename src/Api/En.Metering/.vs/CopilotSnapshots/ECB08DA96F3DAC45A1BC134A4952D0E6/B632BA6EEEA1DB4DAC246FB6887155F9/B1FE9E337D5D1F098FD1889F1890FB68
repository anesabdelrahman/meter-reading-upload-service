using Ensek.Metering.Services.DTOs;
using Ensek.Metering.Services.Interfaces;

namespace Ensek.Metering.Services.Implementations
{
    public class MeterReadingUploadService : IMeterReadingUploadService
    {
        private readonly IMeterReadingProcessor _processor;
        private readonly ICsvParserService<MeterReadingDto> _csvParser;
        private readonly Serilog.ILogger _logger;

        public MeterReadingUploadService(
            IMeterReadingProcessor processor,
            ICsvParserService<MeterReadingDto> csvParser,
            Serilog.ILogger logger)
        {
            _processor = processor;
            _csvParser = csvParser;
            _logger = logger;
        }

        public async Task<(int success, int failed)> ProcessCsvAsync(Stream csvStream, CancellationToken token = default)
        {
            int success = 0;
            int failed = 0;

            try
            {
                await foreach (var record in _csvParser.ParseCsvAsync(csvStream, token))
                {
                    token.ThrowIfCancellationRequested();

                    try
                    {
                        var result = await _processor.ProcessRecordAsync(record, token);

                        if (result.IsSuccess)
                            success++;
                        else
                            failed++;

                        if (!string.IsNullOrEmpty(result.ErrorMessage))
                        {
                            _logger.Warning("Failed to process record: {ErrorMessage}", result.ErrorMessage);
                        }
                    }
                    catch (OperationCanceledException)
                    {
                        throw;
                    }
                    catch (Exception ex)
                    {
                        failed++;
                        _logger.Warning("Exception processing record: {ErrorMessage}", ex.Message);
                    }
                }

                return (success, failed);
            }
            catch (Exception ex) when (ex is not OperationCanceledException)
            {
                _logger.Error(ex, "Error processing CSV file");
                throw;
            }
        }
    }
}